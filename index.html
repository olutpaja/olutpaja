<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pekan Olutpaja - Panokirja Pro</title>
    
    <!-- PWA Meta-tagit -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Panokirja">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Päivitetty Web Manifest (Data URI) - Huom: start_url muutettu muotoon "." -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"Pekan Olutpaja - Panokirja Pro","short_name":"Panokirja","description":"Virallinen oluen panopäiväkirja","start_url":".","display":"standalone","background_color":"#0f172a","theme_color":"#d97706","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/931/931949.png","sizes":"512x512","type":"image/png","purpose":"any maskable"}]}'>

    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --gold: #d97706;
            --text: #f1f5f9;
            --border: #334155;
            --input-bg: #0f172a;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0;
            padding-bottom: 80px; 
            -webkit-tap-highlight-color: transparent;
        }

        /* HEADER */
        .header {
            background: #1e293b;
            border-bottom: 3px solid var(--gold);
            padding: 40px 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            position: sticky; top: 0; z-index: 100;
        }

        .brand-sub { 
            color: var(--gold); 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 6px; 
            margin-bottom: 10px; 
            display: block; 
            font-weight: 800; 
        }

        .brand-main { 
            font-size: 3rem; 
            font-weight: 900; 
            font-style: italic; 
            color: white; 
            margin: 0; 
            letter-spacing: -1px; 
            text-transform: uppercase; 
            line-height: 1; 
        }

        .brand-divider { 
            height: 1px; 
            width: 300px; 
            max-width: 80%;
            background: var(--gold); 
            margin: 20px auto; 
            opacity: 0.8;
        }

        /* VÄLILEHDET */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* NAVIGOINTI */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1e293b;
            display: flex;
            justify-content: center;
            border-top: 1px solid var(--border);
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-btn {
            flex: 1;
            max-width: 200px;
            padding: 15px;
            background: none;
            border: none;
            color: #64748b;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.75rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .nav-btn.active {
            color: var(--gold);
            border-top: 3px solid var(--gold);
        }

        /* KORTIT JA LOMAKKEET */
        .container { max-width: 850px; margin: 40px auto; padding: 0 15px; }

        .card { 
            background: var(--card); 
            border-radius: 20px; 
            padding: 25px; 
            margin-bottom: 30px; 
            border: 1px solid var(--border); 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .card h2 { 
            margin: 0 0 20px 0; 
            font-size: 0.85rem; 
            text-transform: uppercase; 
            color: var(--gold); 
            border-bottom: 1px solid var(--border); 
            padding-bottom: 10px; 
            letter-spacing: 1.5px; 
        }

        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-group { flex: 1; display: flex; flex-direction: column; }
        label { font-size: 0.7rem; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase; font-weight: bold; }
        
        input, textarea, select { 
            background: var(--input-bg); 
            border: 1px solid var(--border); 
            color: white; 
            padding: 12px; 
            border-radius: 8px; 
            font-size: 1rem; 
            width: 100%; 
            box-sizing: border-box; 
        }

        input:focus, textarea:focus { border-color: var(--gold); outline: none; background: #1e293b; }

        /* TAULUKKO */
        .table-container { overflow-x: auto; background: var(--input-bg); border-radius: 12px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 550px; }
        th { font-size: 0.65rem; color: #64748b; padding: 15px; text-align: left; text-transform: uppercase; }
        td { border-top: 1px solid var(--border); padding: 5px; }
        .t-input { background: transparent; border: none; padding: 10px; color: white; width: 100%; font-size: 0.95rem; }

        .abv-val { font-size: 3.5rem; font-weight: 900; color: var(--gold); text-align: center; display: block; font-style: italic; margin-top: 10px; }

        /* PAINIKKEET */
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; text-transform: uppercase; cursor: pointer; font-size: 0.85rem; transition: transform 0.1s; }
        .btn:active { transform: scale(0.95); }
        .btn-save { background: var(--gold); color: black; }
        .btn-del { background: #991b1b; color: white; }

        .backup-section { text-align: center; margin-top: 20px; padding: 20px; border-top: 1px solid var(--border); }
        .btn-utility { background: none; border: 1px solid var(--border); color: #64748b; padding: 8px 16px; border-radius: 6px; font-size: 0.7rem; text-transform: uppercase; cursor: pointer; margin: 5px; letter-spacing: 1px; }
        .btn-utility:hover { color: var(--gold); border-color: var(--gold); }

        footer { text-align: center; padding: 40px 15px; color: #475569; font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; }
        .footer-line { width: 60px; height: 1px; background: var(--border); margin: 0 auto 20px auto; }
        .footer-credit { margin-top: 8px; font-size: 0.65rem; color: #334155; letter-spacing: 1px; font-style: italic; }
        .footer-version { margin-top: 4px; font-size: 0.6rem; color: #1e293b; letter-spacing: 1px; }

        @media (max-width: 480px) { 
            .form-row { flex-direction: column; } 
            .brand-main { font-size: 1.8rem; }
            .card { padding: 15px; }
        }
    </style>
</head>
<body>

<header class="header">
    <span class="brand-sub">Virallinen oluen panopäiväkirja</span>
    <div class="brand-row">
        <h1 class="brand-main" id="header-brewery-name">PEKAN OLUTPAJA</h1>
    </div>
    <div class="brand-divider"></div>
</header>

<main class="container">

    <!-- VÄLILEHTI 1: PANOKIRJA -->
    <div id="tab-diary" class="tab-content active">
        <div class="card">
            <h2>Erien hallinta</h2>
            <select id="batch-select" class="select-style" onchange="loadBatch(this.value)">
                <option value="">-- Valitse erä --</option>
            </select>
            <div class="btn-group">
                <button class="btn btn-save" onclick="saveBatch()">Tallenna erä</button>
                <button class="btn btn-del" onclick="deleteBatch()">Poista erä</button>
            </div>
        </div>

        <section class="card">
            <h2>1. Perustiedot</h2>
            <div class="form-group">
                <label>Oluen Nimi</label>
                <input type="text" id="b-name" placeholder="Esim. Juhannus IPA v2">
            </div>
            <div class="form-row" style="margin-top:20px">
                <div class="form-group">
                    <label>Panopäivämäärä</label>
                    <input type="date" id="b-date">
                </div>
                <div class="form-group">
                    <label>Oluen Tyyli</label>
                    <input type="text" id="b-style" placeholder="IPA, Stout, Pils...">
                </div>
            </div>
        </section>

        <section class="card">
            <h2>2. Panopäivän Tiedot</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Tavoite OG</label>
                    <input type="number" id="b-target-og" step="0.001" placeholder="1.055">
                </div>
                <div class="form-group">
                    <label>Mäskäys (°C/min)</label>
                    <input type="text" id="b-mash" placeholder="67°C / 60min">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Huuhteluvesi (L)</label>
                    <input type="text" id="b-sparge" placeholder="Esim. 15L">
                </div>
                <div class="form-group">
                    <label>Toteutunut OG</label>
                    <input type="number" id="b-actual-og" step="0.001" placeholder="1.052" oninput="calcABV()">
                </div>
            </div>
            <div class="form-group">
                <label>Keittohuomiot & Humalointi</label>
                <textarea id="b-brew-notes" rows="4" placeholder="Esim. 60 min: 20g Magnum, 10 min: 50g Citra..."></textarea>
            </div>
        </section>

        <section class="card">
            <h2>3. Prosessinhallinta</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Aromihumala (Dry Hop)</label>
                    <input type="date" id="b-hop-date">
                </div>
                <div class="form-group">
                    <label>Kylmään siirto (Cold Crash)</label>
                    <input type="date" id="b-cold-date">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Pullotuspäivä</label>
                    <input type="date" id="b-bottle-date">
                </div>
                <div class="form-group">
                    <label>Vierteen määrä (L)</label>
                    <input type="number" id="b-volume" placeholder="20">
                </div>
            </div>
        </section>

        <section class="card">
            <h2>4. Käymisseuranta (14 vrk)</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width:50px; text-align:center">Pvä</th>
                            <th style="width:85px">Lämpö</th>
                            <th style="width:100px">SG</th>
                            <th>Huomiot (Kuplat, maku...)</th>
                        </tr>
                    </thead>
                    <tbody id="diary-body"></tbody>
                </table>
            </div>
        </section>

        <section class="card" style="border: 2px solid var(--gold);">
            <h2>5. Lopputulos</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Lopullinen FG</label>
                    <input type="number" id="b-fg" step="0.001" placeholder="1.010" oninput="calcABV()">
                </div>
                <div class="form-group">
                    <label>Alkoholipitoisuus (ABV)</label>
                    <span id="abv-res" class="abv-val">0.0%</span>
                </div>
            </div>
            <div class="form-group" style="margin-top:15px">
                <label>Maisteluarvio & Kehitysideat</label>
                <textarea id="b-final-notes" rows="4" placeholder="Kuvaile makua ja mitä opit tästä erästä..."></textarea>
            </div>
        </section>

        <div class="backup-section">
            <button class="btn-utility" onclick="exportData()">Vie varmuuskopio (Export JSON)</button>
            <button class="btn-utility" onclick="importData()">Palauta varmuuskopio (Import JSON)</button>
        </div>
    </div>

    <!-- VÄLILEHTI 2: PANIMO INFO -->
    <div id="tab-settings" class="tab-content">
        <section class="card">
            <h2>Asetukset & Panimo</h2>
            <div class="form-group">
                <label>Panimon nimi</label>
                <input type="text" id="set-brewery-name" placeholder="Esim. Pekan Olutpaja">
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label>Panimomestari</label>
                <input type="text" id="set-brewmaster-name" placeholder="Esim. Pekka Niemistö">
            </div>
            <button class="btn btn-save" style="margin-top: 20px; width: 100%;" onclick="saveSettings()">Tallenna asetukset</button>
        </section>
    </div>

</main>

<nav class="nav-bar">
    <button class="nav-btn active" id="nav-diary" onclick="switchTab('diary')">Panokirja</button>
    <button class="nav-btn" id="nav-settings" onclick="switchTab('settings')">Panimo Info</button>
</nav>

<footer>
    <div class="footer-line"></div>
    &copy; 2026 <span id="footer-copy-text">Pekan Olutpaja (Pekka Niemistö)</span>
    <div class="footer-credit">Sovelluksen toteutus: Pekka Niemistö</div>
    <div class="footer-version">Versio 1.1</div>
</footer>

<script>
    const STORAGE_KEY = 'pekan_pro_diary_final_v6';
    const SETTINGS_KEY = 'pekan_pro_settings_v1';
    
    let batches = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    const savedSettings = localStorage.getItem(SETTINGS_KEY);
    let settings = savedSettings ? JSON.parse(savedSettings) : { brewery: "PEKAN OLUTPAJA", master: "Pekka Niemistö" };

    // Service Workerin rekisteröinti (yhden tiedoston mandate)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            const swCode = `
                self.addEventListener('install', e => self.skipWaiting());
                self.addEventListener('fetch', e => e.respondWith(fetch(e.request)));
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl).catch(() => {});
        });
    }

    window.onload = () => {
        const tbody = document.getElementById('diary-body');
        tbody.innerHTML = '';
        for (let i = 1; i <= 14; i++) {
            tbody.innerHTML += `
                <tr>
                    <td style="text-align:center; font-weight:bold; color:var(--gold)">${i}</td>
                    <td><input type="text" class="t-input t-temp" placeholder="°C"></td>
                    <td><input type="text" class="t-input t-sg" placeholder="1.0xx"></td>
                    <td><input type="text" class="t-input t-note" placeholder="..."></td>
                </tr>`;
        }
        updateSelect();
        applySettings(true);
    };

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        document.getElementById('nav-' + tabId).classList.add('active');
        window.scrollTo(0, 0);
    }

    function saveSettings() {
        settings.brewery = document.getElementById('set-brewery-name').value.trim() || "PEKAN OLUTPAJA";
        settings.master = document.getElementById('set-brewmaster-name').value.trim() || "Pekka Niemistö";
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        applySettings(false);
        alert("Asetukset tallennettu!");
    }

    function applySettings(fillInputs) {
        document.getElementById('header-brewery-name').innerText = settings.brewery.toUpperCase();
        document.getElementById('footer-copy-text').innerText = settings.brewery + " (" + settings.master + ")";
        if (fillInputs) {
            document.getElementById('set-brewery-name').value = settings.brewery;
            document.getElementById('set-brewmaster-name').value = settings.master;
        }
    }

    function saveBatch() {
        const name = document.getElementById('b-name').value.trim();
        if (!name) return alert("Anna erälle nimi!");
        const obs = [];
        document.querySelectorAll('#diary-body tr').forEach(row => {
            obs.push({ 
                t: row.querySelector('.t-temp').value, 
                s: row.querySelector('.t-sg').value, 
                n: row.querySelector('.t-note').value 
            });
        });
        batches[name] = {
            name, date: document.getElementById('b-date').value, style: document.getElementById('b-style').value,
            targetOg: document.getElementById('b-target-og').value, mash: document.getElementById('b-mash').value,
            sparge: document.getElementById('b-sparge').value, actualOg: document.getElementById('b-actual-og').value,
            brewNotes: document.getElementById('b-brew-notes').value, hopDate: document.getElementById('b-hop-date').value,
            coldDate: document.getElementById('b-cold-date').value, bottleDate: document.getElementById('b-bottle-date').value,
            volume: document.getElementById('b-volume').value, fg: document.getElementById('b-fg').value,
            finalNotes: document.getElementById('b-final-notes').value, obs
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(batches));
        updateSelect();
        alert("Erä '" + name + "' tallennettu!");
    }

    function loadBatch(name) {
        if (!name) { clearForm(); return; }
        const b = batches[name];
        document.getElementById('b-name').value = b.name || "";
        document.getElementById('b-date').value = b.date || "";
        document.getElementById('b-style').value = b.style || "";
        document.getElementById('b-target-og').value = b.targetOg || "";
        document.getElementById('b-mash').value = b.mash || "";
        document.getElementById('b-sparge').value = b.sparge || "";
        document.getElementById('b-actual-og').value = b.actualOg || "";
        document.getElementById('b-brew-notes').value = b.brewNotes || "";
        document.getElementById('b-hop-date').value = b.hopDate || "";
        document.getElementById('b-cold-date').value = b.coldDate || "";
        document.getElementById('b-bottle-date').value = b.bottleDate || "";
        document.getElementById('b-volume').value = b.volume || "";
        document.getElementById('b-fg').value = b.fg || "";
        document.getElementById('b-final-notes').value = b.finalNotes || "";
        const rows = document.querySelectorAll('#diary-body tr');
        if(b.obs) {
            b.obs.forEach((d, i) => {
                if(rows[i]) {
                    rows[i].querySelector('.t-temp').value = d.t || "";
                    rows[i].querySelector('.t-sg').value = d.s || "";
                    rows[i].querySelector('.t-note').value = d.n || "";
                }
            });
        }
        calcABV();
    }

    function clearForm() {
        document.querySelectorAll('#tab-diary input, #tab-diary textarea').forEach(el => el.value = "");
        document.querySelectorAll('#diary-body input').forEach(el => el.value = "");
        document.getElementById('abv-res').innerText = "0.0%";
    }

    function deleteBatch() {
        const name = document.getElementById('batch-select').value;
        if (name && confirm("Poistetaanko erä '" + name + "' pysyvästi?")) {
            delete batches[name];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(batches));
            location.reload();
        }
    }

    function updateSelect() {
        const sel = document.getElementById('batch-select');
        const current = sel.value;
        sel.innerHTML = '<option value="">-- Valitse erä --</option>';
        Object.keys(batches).sort().forEach(n => {
            sel.innerHTML += `<option value="${n}">${n}</option>`;
        });
        sel.value = current;
    }

    function calcABV() {
        const og = parseFloat(document.getElementById('b-actual-og').value);
        const fg = parseFloat(document.getElementById('b-fg').value);
        const res = document.getElementById('abv-res');
        if (og > 1 && fg > 1) { res.innerText = ((og - fg) * 131.25).toFixed(1) + "%"; } 
        else { res.innerText = "0.0%"; }
    }

    function exportData() {
        const data = JSON.stringify(batches, null, 2);
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `olutpaja_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
    }

    function importData() {
        const json = prompt("Liitä varmuuskopio (JSON-teksti) tähän:");
        if (json) {
            try {
                const parsed = JSON.parse(json);
                if (confirm("Tämä korvaa nykyiset tiedot. Jatketaanko?")) {
                    batches = parsed;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(batches));
                    location.reload();
                }
            } catch (e) { alert("Virheellinen JSON!"); }
        }
    }
</script>
</body>
</html>
